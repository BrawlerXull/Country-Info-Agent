<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Country Info Agent</title>
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      body {
        font-family: sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      #chat-box {
        border: 1px solid #ccc;
        padding: 20px;
        height: 400px;
        overflow-y: scroll;
        margin-bottom: 20px;
      }
      .message {
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 5px;
      }
      .user {
        background-color: #e3f2fd;
        text-align: right;
      }
      .agent {
        background-color: #f5f5f5;
      }
      /* Markdown styling for agent messages */
      .agent strong, .agent b {
        font-weight: bold;
      }
      .agent ul, .agent ol {
        margin: 8px 0;
        padding-left: 20px;
      }
      .agent li {
        margin: 4px 0;
      }
      .agent p {
        margin: 8px 0;
      }
      .agent code {
        background-color: #e0e0e0;
        padding: 2px 6px;
        border-radius: 3px;
      }
      input {
        width: 70%;
        padding: 10px;
      }
      button {
        padding: 10px 20px;
      }
    </style>
  </head>
  <body>
    <h1>Country Information Agent</h1>
    <div id="chat-box"></div>
    <input
      type="text"
      id="user-input"
      placeholder="Ask about a country (e.g. Population of France?)"
    />
    <button onclick="sendMessage()">Send</button>
    <button onclick="startNewSession()" style="background-color: #f0f0f0; margin-left: 10px;">New Session</button>

    <script>
      // Generate a random session ID
      let sessionId = 'session_' + Math.random().toString(36).substr(2, 9);
      console.log("Session ID:", sessionId);

      // Configure marked for safe rendering
      marked.setOptions({
        breaks: true,  // Convert \n to <br>
        gfm: true      // GitHub Flavored Markdown
      });

      // Helper function to parse markdown
      function parseMarkdown(text) {
        return marked.parse(text);
      }

      function startNewSession() {
          sessionId = 'session_' + Math.random().toString(36).substr(2, 9);
          console.log("New Session ID:", sessionId);
          
          document.getElementById("chat-box").innerHTML = '<div class="message agent" style="font-style: italic;">System: New session started.</div>';
          document.getElementById("user-input").value = "";
      }

      async function sendMessage() {
        const input = document.getElementById("user-input");
        const chatBox = document.getElementById("chat-box");
        const text = input.value.trim();

        if (!text) return;

        // Add user message (no markdown parsing for user input)
        chatBox.innerHTML += `<div class="message user"><strong>You:</strong> ${text}</div>`;
        input.value = "";

        try {
          const response = await fetch("/query", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ question: text, session_id: sessionId }),
          });

          const data = await response.json();

          if (response.ok) {
            // Parse markdown in the agent's answer
            const parsedAnswer = parseMarkdown(data.answer);
            chatBox.innerHTML += `<div class="message agent"><strong>Agent:</strong> ${parsedAnswer}</div>`;
            if (data.countries && data.countries.length > 0) {
              const contextStr = data.countries.join(", ");
              chatBox.innerHTML += `<div class="message agent" style="font-size: 0.8em; color: gray;">(Context: ${contextStr}, Intent: ${data.intent})</div>`;
            }
          } else {
            chatBox.innerHTML += `<div class="message agent" style="color: red;">Error: ${data.detail || "Unknown error"}</div>`;
          }
        } catch (e) {
          chatBox.innerHTML += `<div class="message agent" style="color: red;">Network Error: ${e.message}</div>`;
        }

        chatBox.scrollTop = chatBox.scrollHeight;
      }

      document
        .getElementById("user-input")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            sendMessage();
          }
        });
    </script>
  </body>
</html>
